#!/bin/bash

# === –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Git LFS –¥–ª—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è llama-mutant ===

REPO_DIR="$HOME/GIT/llama-mutant"
GGUF_PATTERN="model/*.gguf"
LFS_TYPES=(".gguf" ".bin" ".pt" ".pth" ".ckpt" ".safetensors")

cd "$REPO_DIR" || { echo "‚ùå –ù–µ –º–æ–≥—É –ø–µ—Ä–µ–π—Ç–∏ –≤ –ø–∞–ø–∫—É: $REPO_DIR"; exit 1; }

echo "üìÅ –†–∞–±–æ—Ç–∞–µ–º –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏: $REPO_DIR"

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ git-lfs
if ! command -v git-lfs &> /dev/null; then
    echo "‚¨áÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é Git LFS..."
    cd /tmp || exit 1
    curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | sudo bash
    apt-get install git-lfs -y || { echo "‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ git-lfs"; exit 1; }
    cd "$REPO_DIR"
else
    echo "‚úÖ Git LFS —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
fi

# 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Git LFS
echo "üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é Git LFS..."
git lfs install

# 3. –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ç–∏–ø–æ–≤ —Ñ–∞–π–ª–æ–≤
echo "üéØ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ LFS..."

for ext in "${LFS_TYPES[@]}"; do
    git lfs track "$ext"
done

# –¢–∞–∫–∂–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—É—Ç—å –∫ –º–æ–¥–µ–ª–∏ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
git lfs track "model/*.gguf"

# 4. –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ .gitattributes –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–Ω–¥–µ–∫—Å
echo "üìù –ü—Ä–æ–≤–µ—Ä—è—é .gitattributes..."
if [ ! -f ".gitattributes" ]; then
    echo "‚ö†Ô∏è –§–∞–π–ª .gitattributes –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º..."
    git lfs track > .gitattributes
else
    git lfs track >> .gitattributes 2>/dev/null || true
fi

# 5. –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
echo "‚úÖ –î–æ–±–∞–≤–ª—è—é .gitattributes –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ LFS –≤ –∫–æ–º–º–∏—Ç..."
git add .gitattributes

# 6. –£–¥–∞–ª—è–µ–º –∏–∑ –æ–±—ã—á–Ω–æ–≥–æ Git'–∞ –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª (–µ—Å–ª–∏ –æ–Ω —É–∂–µ –∑–∞–∫–æ–º–º–∏—á–µ–Ω)
echo "üßπ –£–¥–∞–ª—è—é .gguf –∏–∑ –æ–±—ã—á–Ω–æ–≥–æ Git (—á—Ç–æ–±—ã –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ LFS)..."
git rm --cached model/*.gguf 2>/dev/null || echo "‚û°Ô∏è –ù–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö .gguf —Ñ–∞–π–ª–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è"

# 7. –ö–æ–º–º–∏—Ç–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
git add .
git commit -m "üîß LFS: –≤–∫–ª—é—á–µ–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ .gguf –∏ –¥—Ä—É–≥–∏—Ö –±–∏–Ω–∞—Ä–Ω–∏–∫–æ–≤" || echo "‚û°Ô∏è –ù–µ—á–µ–≥–æ –∫–æ–º–º–∏—Ç–∏—Ç—å (–≤–æ–∑–º–æ–∂–Ω–æ, –∏–∑–º–µ–Ω–µ–Ω–∏—è —É–∂–µ –µ—Å—Ç—å)"

# 8. –ü—É—à–∏–º –≤—Å—ë
echo "üöÄ –í—ã–ø–æ–ª–Ω—è—é push..."
git push origin main

echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Git LFS –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo "üí° –¢–µ–ø–µ—Ä—å –±–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤ LFS. –°–ª–µ–¥—É—é—â–∏–µ —Ç–∏–ø—ã —Ñ–∞–π–ª–æ–≤ —Ç–µ–ø–µ—Ä—å –ø–æ–¥ LFS: ${LFS_TYPES[*]}"
