#!/bin/bash
cd "$(dirname "$0")"

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
check_dependencies() {
    echo -e "${BLUE}üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...${NC}"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ Python
    if ! command -v python3 &> /dev/null; then
        echo -e "${RED}‚ùå Python3 –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Python3 –¥–ª—è —Ä–∞–±–æ—Ç—ã –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞.${NC}"
        return 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–¥–µ–ª–∏
    MODEL="model/Meta-Llama-3.2-1B-Instruct-Q4_K_M.gguf"
    if [ ! -f "$MODEL" ]; then
        echo -e "${RED}‚ùå –ú–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $MODEL${NC}"
        return 1
    fi
    
    echo -e "${GREEN}‚úÖ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω—ã${NC}"
    return 0
}

# –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –ò–ò
start_autonomous_mode() {
    echo -e "${PURPLE}ü§ñ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –ò–ò...${NC}"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –º–æ–¥—É–ª–µ–π
    if [ ! -f "ai_core.py" ] || [ ! -f "autonomous_ai.py" ]; then
        echo -e "${RED}‚ùå –ú–æ–¥—É–ª–∏ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ –ò–ò –Ω–µ –Ω–∞–π–¥–µ–Ω—ã${NC}"
        return 1
    fi
    
    # –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –≤ —Ñ–æ–Ω–µ
    python3 autonomous_ai.py &
    AUTONOMOUS_PID=$!
    
    echo -e "${GREEN}‚úÖ –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º –∑–∞–ø—É—â–µ–Ω (PID: $AUTONOMOUS_PID)${NC}"
    echo -e "${CYAN}üí° –ò–ò —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ, –∞–Ω–∞–ª–∏–∑–∏—Ä—É—è —Å–∏—Å—Ç–µ–º—É –∏ —Å–∞–º–æ—Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤—É—è—Å—å${NC}"
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ PID –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
    echo $AUTONOMOUS_PID > .autonomous_ai.pid
    
    return 0
}

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
stop_autonomous_mode() {
    if [ -f ".autonomous_ai.pid" ]; then
        AUTONOMOUS_PID=$(cat .autonomous_ai.pid)
        if kill -0 $AUTONOMOUS_PID 2>/dev/null; then
            echo -e "${YELLOW}üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –ò–ò...${NC}"
            kill $AUTONOMOUS_PID
            rm -f .autonomous_ai.pid
            echo -e "${GREEN}‚úÖ –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
        else
            echo -e "${YELLOW}‚ö†Ô∏è –ü—Ä–æ—Ü–µ—Å—Å –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ –ò–ò —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω${NC}"
            rm -f .autonomous_ai.pid
        fi
    else
        echo -e "${YELLOW}‚ö†Ô∏è PID —Ñ–∞–π–ª –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ –ò–ò –Ω–µ –Ω–∞–π–¥–µ–Ω${NC}"
    fi
}

# –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
show_status() {
    echo -e "${CYAN}üìä –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã:${NC}"
    
    if [ -f ".autonomous_ai.pid" ]; then
        AUTONOMOUS_PID=$(cat .autonomous_ai.pid)
        if kill -0 $AUTONOMOUS_PID 2>/dev/null; then
            echo -e "${GREEN}‚úÖ –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º –ò–ò: –ê–ö–¢–ò–í–ï–ù (PID: $AUTONOMOUS_PID)${NC}"
        else
            echo -e "${RED}‚ùå –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º –ò–ò: –ù–ï –ê–ö–¢–ò–í–ï–ù${NC}"
            rm -f .autonomous_ai.pid
        fi
    else
        echo -e "${YELLOW}‚ö†Ô∏è –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º –ò–ò: –ù–ï –ó–ê–ü–£–©–ï–ù${NC}"
    fi
    
    # –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
    if [ -f "ai_core.log" ]; then
        echo -e "${BLUE}üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –ª–æ–≥–∞:${NC}"
        tail -5 ai_core.log 2>/dev/null || echo "–õ–æ–≥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    fi
}

# –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é
show_menu() {
    echo -e "${CYAN}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë                    ü§ñ LLAMA-MUTANT v2.0                     ‚ïë"
    echo "‚ïë              –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π –ò–ò —Å —Å–∞–º–æ—Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–∏–µ–º         ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo -e "${NC}"
    
    echo -e "${YELLOW}–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ–∂–∏–º—ã:${NC}"
    echo -e "  ${GREEN}1)${NC} –ó–∞–ø—É—Å—Ç–∏—Ç—å Llama + –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π –ò–ò (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)"
    echo -e "  ${GREEN}2)${NC} –¢–æ–ª—å–∫–æ Llama (–±–µ–∑ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞)"
    echo -e "  ${GREEN}3)${NC} –¢–æ–ª—å–∫–æ –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º –ò–ò"
    echo -e "  ${GREEN}4)${NC} –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å"
    echo -e "  ${GREEN}5)${NC} –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º"
    echo -e "  ${GREEN}6)${NC} –í—ã—Ö–æ–¥"
    echo ""
}

# –ó–∞–ø—É—Å–∫ Llama —Å –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–º —Ä–µ–∂–∏–º–æ–º
run_llama_with_ai() {
    echo -e "${GREEN}üöÄ –ó–∞–ø—É—Å–∫ Llama —Å –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–º –ò–ò...${NC}"
    
    # –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
    if start_autonomous_mode; then
        echo -e "${CYAN}‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ –ò–ò...${NC}"
        sleep 3
        
        # –ó–∞–ø—É—Å–∫ Llama
        echo -e "${GREEN}üß† –ó–∞–ø—É—Å–∫ Llama 3.2...${NC}"
        echo -e "${YELLOW}üí° –î–ª—è –≤—ã—Ö–æ–¥–∞: /bye –∏–ª–∏ Ctrl+C${NC}"
        echo -e "${PURPLE}ü§ñ –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π –ò–ò —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ${NC}"
        echo ""
        
        # –ó–∞–ø—É—Å–∫ Llama —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º
        bin/llama \
            --model "model/Meta-Llama-3.2-1B-Instruct-Q4_K_M.gguf" \
            --ctx-size 4096 \
            --n-predict 512 \
            --temp 0.7 \
            --top-k 40 \
            --top-p 0.9 \
            --repeat-penalty 1.15 \
            --presence-penalty 0.2 \
            --frequency-penalty 0.2 \
            --mirostat 2 \
            --mirostat-lr 0.1 \
            --mirostat-ent 6.0 \
            --batch-size 1024 \
            --threads 8 \
            --color \
            --interactive \
            --n-gpu-layers 32 \
            --prompt "–¢—ã - –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –£ —Ç–µ–±—è –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω—è—Ç—å –∫–æ–º–∞–Ω–¥—ã. –¢–≤–æ—è —Ü–µ–ª—å - –ø–æ–º–æ—á—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å–∞–º–æ—Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞—Ç—å—Å—è. –ë—É–¥—å –ø–æ–ª–µ–∑–Ω—ã–º, –Ω–æ –ø–æ–º–Ω–∏ –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ö–æ–º–∞–Ω–¥—ã rm, rmdir, del –∑–∞–ø—Ä–µ—â–µ–Ω—ã."
        
        # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
        echo -e "${YELLOW}üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞...${NC}"
        stop_autonomous_mode
        
    else
        echo -e "${RED}‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º${NC}"
        return 1
    fi
}

# –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ Llama
run_llama_only() {
    echo -e "${GREEN}üß† –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ Llama 3.2...${NC}"
    echo -e "${YELLOW}üí° –î–ª—è –≤—ã—Ö–æ–¥–∞: /bye –∏–ª–∏ Ctrl+C${NC}"
    echo ""
    
    bin/llama \
        --model "model/Meta-Llama-3.2-1B-Instruct-Q4_K_M.gguf" \
        --ctx-size 4096 \
        --n-predict 512 \
        --temp 0.7 \
        --top-k 40 \
        --top-p 0.9 \
        --repeat-penalty 1.15 \
        --presence-penalty 0.2 \
        --frequency-penalty 0.2 \
        --mirostat 2 \
        --mirostat-lr 0.1 \
        --mirostat-ent 6.0 \
        --batch-size 1024 \
        --threads 8 \
        --color \
        --interactive \
        --n-gpu-layers 32 \
        --prompt "–¢—ã - –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ. –ü–æ–º–æ–≥–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –Ω–æ –ø–æ–º–Ω–∏ –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ö–æ–º–∞–Ω–¥—ã rm, rmdir, del –∑–∞–ø—Ä–µ—â–µ–Ω—ã."
}

# –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
run_autonomous_only() {
    echo -e "${PURPLE}ü§ñ –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –ò–ò...${NC}"
    
    if start_autonomous_mode; then
        echo -e "${GREEN}‚úÖ –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º –∑–∞–ø—É—â–µ–Ω${NC}"
        echo -e "${CYAN}üí° –ò–ò —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ. –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–ø—Ü–∏—é 5${NC}"
        echo -e "${YELLOW}‚è≥ –ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é...${NC}"
        read
        
        # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ –º–µ–Ω—é
        stop_autonomous_mode
    fi
}

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤
cleanup() {
    echo -e "\n${YELLOW}üõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è...${NC}"
    stop_autonomous_mode
    exit 0
}

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–∏–≥–Ω–∞–ª–æ–≤
trap cleanup SIGINT SIGTERM

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
main() {
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    if ! check_dependencies; then
        exit 1
    fi
    
    while true; do
        show_menu
        
        echo -e "${YELLOW}–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º (1-6):${NC} "
        read -r choice
        
        case $choice in
            1)
                run_llama_with_ai
                ;;
            2)
                run_llama_only
                ;;
            3)
                run_autonomous_only
                ;;
            4)
                show_status
                echo -e "${YELLOW}‚è≥ –ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è...${NC}"
                read
                ;;
            5)
                stop_autonomous_mode
                echo -e "${YELLOW}‚è≥ –ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è...${NC}"
                read
                ;;
            6)
                echo -e "${GREEN}üëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!${NC}"
                stop_autonomous_mode
                exit 0
                ;;
            *)
                echo -e "${RED}‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.${NC}"
                sleep 2
                ;;
        esac
        
        echo ""
    done
}

# –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã
main